#!/usr/bin/env python
# -*- coding: utf-8 -*-

import config              # main config with token
import telebot
from telebot import types  # inline types
import cherrypy
import urllib
import socket
import time
import logging
from selenium import webdriver
from PIL import Image

bot = telebot.TeleBot(config.token)

WEBHOOK_HOST = 'www.pfpgupsbot.herokuapp.com'
WEBHOOK_PORT = 8443  # 443, 80, 88 или 8443 (порт должен быть открыт!)
WEBHOOK_LISTEN = 'www.pfpgupsbot.herokuapp.com'  # На некоторых серверах придется указывать такой же IP, что и выше

WEBHOOK_SSL_CERT = 'webhook_cert.pem'  # Путь к сертификату
WEBHOOK_SSL_PRIV = 'webhook_pkey.pem'  # Путь к приватному ключу

WEBHOOK_URL_BASE = "https://%s:%s" % (WEBHOOK_HOST, WEBHOOK_PORT)
WEBHOOK_URL_PATH = "/%s/" % (config.token)

logger = telebot.logger
telebot.logger.setLevel(logging.INFO)

class WebhookServer(object):
    @cherrypy.expose
    def index(self):
        if 'content-length' in cherrypy.request.headers and \
           'content-type' in cherrypy.request.headers and \
           cherrypy.request.headers['content-type'] == 'application/json':
            length = int(cherrypy.request.headers['content-length'])
            json_string = cherrypy.request.body.read(length).decode("utf-8")
            update = telebot.types.Update.de_json(json_string)
            bot.process_new_updates([update])
            return ''
        else:
            raise cherrypy.HTTPError(403)
            
@bot.message_handler(commands=['start'])
def start_menu(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add('рџ‘Ѓ РњРµРЅСЋ') 
    username = message.from_user.first_name
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРёС‚Рµ РњРµРЅСЋ', reply_markup=markup) # РўРµРєСЃС‚ РїСЂРёРІРµС‚СЃС‚РІРёСЏ

@bot.message_handler(func=lambda message: message.text == 'рџ‘Ѓ РњРµРЅСЋ')
def menu(message):
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(config.markup_1) 
    markup.add(config.markup_2)
    username = message.from_user.first_name
    msg = bot.send_message(message.chat.id, 'Р§РµРј СЏ РјРѕРіСѓ Р’Р°Рј РїРѕРјРѕС‡СЊ, ' + username + '?', reply_markup=markup)
    
@bot.message_handler(func=lambda message: message.text == 'РЎРѕР·РґР°С‚СЊ')
def create(message):
    try:
        code = urllib.request.urlopen(config.updatescript_url).getcode()
        print("{0} - {1}".format(config.updatescript_url, code))
        codePPK = urllib.request.urlopen(config.updatescriptPPK_url).getcode()
        print("{0} - {1}".format(config.updatescriptPPK_url, codePPK))
        if (code not in [200, 301]) or (codePPK not in [200, 301]):
            print('ERROR: {0} - {1}')
        else:
            print('UPDATESCRIPT: is in progress..')
            print('UPDATESCRIPTPPK: is in progress..')
            driver = webdriver.PhantomJS()
            driver.set_window_size(800, 600)
            driver.get(config.updatescript_url) # url changes
            driver.save_screenshot(config.chng_file)
            driverPPK = webdriver.PhantomJS()
            driverPPK.set_window_size(800, 600)
            driverPPK.get(config.updatescriptPPK_url) # url changes
            driverPPK.save_screenshot(config.chngPPK_file)
            print('UPDATESCRIPT: success!')
            print('UPDATESCRIPTPPK: success!')
    except socket.error as e:
        print('PING ERROR: ', e)
       
@bot.message_handler(func=lambda message: message.text == config.markup_1) 
def changes(message):
    chat_id = message.chat.id
    try:
        changes_im = Image.open(config.chng_file)
        (width, height) = changes_im.size
        frame = changes_im.crop((310, 696, 1008, height - 550))
        frame.save(config.chng_frame)
        changes_im1 = Image.open(config.chng_frame)
        (width_frame, height_frame) = changes_im1.size
        part1 = changes_im1.crop((0, 0, width_frame, 1231))
        part1.save(config.chng_part1)
        changes_im2 = Image.open(config.chng_frame)
        part2 = changes_im2.crop((0, 1231, width_frame, height_frame))
        part2.save(config.chng_part2)
        photo_part1 = open(config.chng_part1, 'rb')
        bot.send_photo(message.chat.id, photo_part1)
        photo_part2 = open(config.chng_part2, 'rb')
        bot.send_photo(message.chat.id, photo_part2)
        print('USER: ' + str(message.chat.id) + '@' + str(message.from_user.first_name) + str(message.from_user.last_name) + ' used command: CHANGES PF PGUPS') 
    except (OSError, IOError) as e:
        print('ERROR:', e)
        
@bot.message_handler(func=lambda message: message.text == config.markup_2)  
def rasp(message):
    rasp_cust_key = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    rasp_cust_key.add('рџ‘·вЂЌ РџСѓС‚РµРІРѕРµ С…РѕР·.', 'рџ‘ЁвЂЌрџ’» РљРѕРјРї.СЃРµС‚Рё') 
    rasp_cust_key.add('рџљќ Р­Р»РµРєС‚СЂРѕСЃРЅР°Р±Р¶.', 'рџљѓ РћСЂРі.РїРµСЂРµРІРѕР·.')
    rasp_cust_key.add('рџљ‚ РўРµС….СЌРєСЃРї.Рї.СЃ', 'рџљ‡ РђРІС‚. Рё С‚РµР»РµРјРµС….')
    rasp_cust_key.add('рџ‘Ѓ РњРµРЅСЋ')
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРё РЅР°РїСЂР°РІР»РµРЅРёРµ РІ РјРµРЅСЋ:', reply_markup=rasp_cust_key)
    print('USER: ' + str(message.chat.id) + '@' + str(message.from_user.first_name) + str(message.from_user.last_name) + ' used command: RASPISANIE PF PGUPS')
    
@bot.message_handler(func=lambda message: message.text == 'рџ‘·вЂЌ РџСѓС‚РµРІРѕРµ С…РѕР·.') 
def put(message):
    global chat_id
    #global us_first
    #global us_last 
    chat_id = message.chat.id
    #us_first = message.from_user.first_name
    #us_last = message.from_user.last_name
    kb_rasp = types.InlineKeyboardMarkup()
    kb_rasp.add(types.InlineKeyboardButton('Рџ-471', callback_data='Рџ-471'), types.InlineKeyboardButton('Рџ-472', callback_data='Рџ-472'))
    kb_rasp.add(types.InlineKeyboardButton('Рџ-469', callback_data='Рџ-469'), types.InlineKeyboardButton('Рџ-470', callback_data='Рџ-470'))
    kb_rasp.add(types.InlineKeyboardButton('Рџ-468', callback_data='Рџ-468'))
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРё РіСЂСѓРїРїСѓ Рё РЅР°Р¶РјРё РЅР° РЅРµРµ:', reply_markup=kb_rasp)

@bot.message_handler(func=lambda message: message.text == 'рџ‘ЁвЂЌрџ’» РљРѕРјРї.СЃРµС‚Рё') 
def vte(message):
    global chat_id
    chat_id = message.chat.id
    kb_rasp = types.InlineKeyboardMarkup()
    kb_rasp.add(types.InlineKeyboardButton('Р’Рў-518', callback_data='Р’Рў-518'), types.InlineKeyboardButton('Р’Рў-519,520', callback_data='Р’Рў-519,520'))
    kb_rasp.add(types.InlineKeyboardButton('Р’Рў-516', callback_data='Р’Рў-516'), types.InlineKeyboardButton('Р’Рў-517', callback_data='Р’Рў-517'))
    kb_rasp.add(types.InlineKeyboardButton('Р’Рў-514,515', callback_data='Р’Рў-514,515'))
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРё РіСЂСѓРїРїСѓ Рё РЅР°Р¶РјРё РЅР° РЅРµРµ:', reply_markup=kb_rasp)

@bot.message_handler(func=lambda message: message.text == 'рџљќ Р­Р»РµРєС‚СЂРѕСЃРЅР°Р±Р¶.') 
def electro(message):
    global chat_id
    chat_id = message.chat.id
    kb_rasp = types.InlineKeyboardMarkup()
    kb_rasp.add(types.InlineKeyboardButton('Р­-289,291', callback_data='Р­-289,291'), types.InlineKeyboardButton('Р­-285,287', callback_data='Р­-285,287'))
    kb_rasp.add(types.InlineKeyboardButton('Р­-281,283', callback_data='Р­-281,283'), types.InlineKeyboardButton('Р­-279', callback_data='Р­-279'))
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРё РіСЂСѓРїРїСѓ Рё РЅР°Р¶РјРё РЅР° РЅРµРµ:', reply_markup=kb_rasp)

@bot.message_handler(func=lambda message: message.text == 'рџљѓ РћСЂРі.РїРµСЂРµРІРѕР·.') 
def dvij(message):
    global chat_id
    chat_id = message.chat.id
    kb_rasp = types.InlineKeyboardMarkup()
    kb_rasp.add(types.InlineKeyboardButton('Р”-370,371', callback_data='Р”-370,371'), types.InlineKeyboardButton('Р”-372,373', callback_data='Р”-372,373'))
    kb_rasp.add(types.InlineKeyboardButton('Р”-366,367', callback_data='Р”-366,367'), types.InlineKeyboardButton('Р”-368,369', callback_data='Р”-368,369'))
    kb_rasp.add(types.InlineKeyboardButton('Р”-364,365', callback_data='Р”-364,365'))
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРё РіСЂСѓРїРїСѓ Рё РЅР°Р¶РјРё РЅР° РЅРµРµ:', reply_markup=kb_rasp)

@bot.message_handler(func=lambda message: message.text == 'рџљ‚ РўРµС….СЌРєСЃРї.Рї.СЃ') 
def teh(message):
    global chat_id
    chat_id = message.chat.id
    kb_rasp = types.InlineKeyboardMarkup()
    kb_rasp.add(types.InlineKeyboardButton('Рў-182', callback_data='Рў-182'), types.InlineKeyboardButton('Рў-184', callback_data='Рў-184'))
    kb_rasp.add(types.InlineKeyboardButton('Рў-178,180', callback_data='Рў-178,180'), types.InlineKeyboardButton('Р’-183,185', callback_data='Р’-183,185'))
    kb_rasp.add(types.InlineKeyboardButton('Р’-179,181', callback_data='Р’-179,181'), types.InlineKeyboardButton('Р’-177', callback_data='Р’-177'))
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРё РіСЂСѓРїРїСѓ Рё РЅР°Р¶РјРё РЅР° РЅРµРµ:', reply_markup=kb_rasp)

@bot.message_handler(func=lambda message: message.text == 'рџљ‡ РђРІС‚. Рё С‚РµР»РµРјРµС….') 
def automat(message):
    global chat_id
    chat_id = message.chat.id
    kb_rasp = types.InlineKeyboardMarkup()
    kb_rasp.add(types.InlineKeyboardButton('РЁ-288,290', callback_data='РЁ-288,290'), types.InlineKeyboardButton('РЁ-280,282', callback_data='1'))
    kb_rasp.add(types.InlineKeyboardButton('РЁ-284,286', callback_data='РЁ-284,286'))
    msg = bot.send_message(message.chat.id, 'Р’С‹Р±РµСЂРё РіСЂСѓРїРїСѓ Рё РЅР°Р¶РјРё РЅР° РЅРµРµ:', reply_markup=kb_rasp)    
    
@bot.callback_query_handler(func=lambda data_rasp: True)
def inline(data_rasp):
    if data_rasp.data == 'Рџ-471':
        photo_rasp = open('p-471.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
    elif data_rasp.data == 'Рџ-472':
        photo_rasp = open('p-472.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass
    elif data_rasp.data == 'Рџ-469':
        photo_rasp = open('p-469.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass
    elif data_rasp.data == 'Рџ-470':
        photo_rasp = open('p-470.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass
    elif data_rasp.data == 'Рџ-468':
        photo_rasp = open('p-468.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass
    elif data_rasp.data == 'Р’Рў-518':
        photo_rasp = open('vt-518.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)      
        pass
    elif data_rasp.data == 'Р’Рў-519,520':
        photo_rasp = open('vt-519.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)        
        pass
    elif data_rasp.data == 'Р’Рў-516':
        photo_rasp = open('vt-516.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)        
        pass
    elif data_rasp.data == 'Р’Рў-517':
        photo_rasp = open('vt-517.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)       
        pass
    elif data_rasp.data == 'Р’Рў-514,515':
        photo_rasp = open('vt-514.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)        
        pass
    elif data_rasp.data == 'Р­-289,291':
        photo_rasp = open('e-289.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)        
        pass
    elif data_rasp.data == 'Р­-285,287':
        photo_rasp = open('e-285.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)      
        pass
    elif data_rasp.data == 'Р­-281,283':
        photo_rasp = open('e-281.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)       
        pass
    elif data_rasp.data == 'Р­-279':
        photo_rasp = open('e-279.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)       
        pass
    elif data_rasp.data == 'Р”-370,371':
        photo_rasp = open('d-370.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)       
        pass
    elif data_rasp.data == 'Р”-372,373':
        photo_rasp = open('d-372.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)        
        pass
    elif data_rasp.data == 'Р”-366,367':
        photo_rasp = open('d-366.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)      
        pass
    elif data_rasp.data == 'Р”-368,369':
        photo_rasp = open('d-368.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)       
        pass
    elif data_rasp.data == 'Р”-364,365':
        photo_rasp = open('d-364.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)     
        pass
    elif data_rasp.data == 'Рў-182':
        photo_rasp = open('t-182.png', 'rb')
        bot.send_photo(chat_id, photo_rasp) 
        pass
    elif data_rasp.data == 'Рў-184':
        photo_rasp = open('t-184.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)        
        pass
    elif data_rasp.data == 'Рў-178,180':
        photo_rasp = open('t-178.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass
    elif data_rasp.data == 'Р’-183,185':
        photo_rasp = open('v-183.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)       
        pass
    elif data_rasp.data == 'Р’-179,181':
        photo_rasp = open('v-179.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass
    elif data_rasp.data == 'Р’-177':
        photo_rasp = open('v-177.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass
    elif data_rasp.data == 'РЁ-288,290':
        photo_rasp = open('sh-288.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)        
        pass
    elif data_rasp.data == 'РЁ-280,282':
        photo_rasp = open('sh-280.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)     
        pass
    elif data_rasp.data == 'РЁ-284,286':
        photo_rasp = open('sh-284.png', 'rb')
        bot.send_photo(chat_id, photo_rasp)
        pass

# Remove webhook, it fails sometimes the set if there is a previous webhook
bot.remove_webhook()

# Set webhook
bot.set_webhook(url=WEBHOOK_URL_BASE+WEBHOOK_URL_PATH,
                certificate=open(WEBHOOK_SSL_CERT, 'r'))

# Disable CherryPy requests log
access_log = cherrypy.log.access_log
for handler in tuple(access_log.handlers):
    access_log.removeHandler(handler)

# Start cherrypy server
cherrypy.config.update({
    'server.socket_host': WEBHOOK_LISTEN,
    'server.socket_port': WEBHOOK_PORT,
    'server.ssl_module': 'builtin',
    'server.ssl_certificate': WEBHOOK_SSL_CERT,
    'server.ssl_private_key': WEBHOOK_SSL_PRIV
})

cherrypy.quickstart(WebhookServer(), WEBHOOK_URL_PATH, {'/': {}})            
    


